name: "ğŸš€ Deploy: Development"
run-name: ğŸ“Œ  <${{ inputs.deploy_to }}> é–‹ç™ºç’°å¢ƒã¸ ${{ github.ref_name }} ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ ğŸš€

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      deploy_to:
        type: choice
        description: Deploy to
        default: cloud-run
        options:
          - cloud-run
          - lambda

# æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åŒæ™‚ã«å®Ÿè¡Œã§ããªã„ã‚ˆã†ã«ã‚³ãƒ³ã‚«ãƒ¬ãƒ³ã‚·ãƒ¼ã‚’ä½¿ç”¨
concurrency: ${{ github.workflow }}

jobs:
  test:
    name: 'âœ… ãƒ†ã‚¹ãƒˆ'
    uses: ./.github/workflows/_test.yml
    with:
      python-version: '3.12'

  deploy-cloud-run:
    if: ${{ github.event.inputs.deploy_to == 'cloud-run' }}
    needs: test
    name: 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤'
    uses: ./.github/workflows/_deploy-to-cloud-run.yml
    with:
      project-id: ${{ vars.GCP_PROJECT_ID }}
      workload-identity-provider: ${{ vars.GCP_WIF_PROVIDER }}
      service-account: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}
      registry: 'clean-architecture'
      cloud-run-name: 'clean-architecture-development'
      region: 'asia-northeast1'

  deploy-lambda:
    if: ${{ github.event.inputs.deploy_to == 'lambda' }}
    needs: test
    name: 'ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤'
    uses: ./.github/workflows/_deploy-to-lambda.yml
    with:
      aws-access-key-id: 'xxx'
      aws-secret-access-key: 'xxx'
      registry: 'xxx'
      region: 'ap-northeast-1'
